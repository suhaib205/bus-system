<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>نظام الرحلات وحجوزات الباصات</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
    body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; margin: 0; padding: 0; }
    .seat-grid { display: grid; grid-template-columns: 1fr 1fr 0.4fr 1fr 1fr; gap: 10px; }
    .back-bench { display: flex; gap: 6px; grid-column: span 5; margin-top: 10px; }
    .print-only { display: none; }
    @media print {
      @page { size: A4; margin: 10mm; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white; }
      .print-container { border: 2px solid black !important; padding: 16px; border-radius: 0; }
    }
  </style>
</head>

<body>
  <div id="auth-loading" class="min-h-screen flex items-center justify-center text-slate-500">
    جار التحقق من تسجيل الدخول...
  </div>

  <div id="root" style="display:none"></div>

  <!-- ✅ Auth Guard + Firestore bootstrap -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDocs, setDoc, addDoc, deleteDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2z69uVLcbaQo_BJ3sJic8kyhZaS8uRuE",
      authDomain: "suhaib-bus-system.firebaseapp.com",
      projectId: "suhaib-bus-system",
      messagingSenderId: "992934203240",
      appId: "1:992934203240:web:be7c580c8b8e5f87ce50dd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // helpers exposed to React
    window.__BUS = {
      auth,
      db,
      signOut: () => signOut(auth),

      // Firestore paths (set after login)
      uid: null,
      busesCol: null,
      tripsCol: null,

      async loadAll() {
        const busesSnap = await getDocs(this.busesCol);
        const tripsSnap = await getDocs(this.tripsCol);

        const buses = busesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        const trips = tripsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        return { buses, trips };
      },

      async createBus(bus) {
        const ref = await addDoc(this.busesCol, bus);
        return { id: ref.id, ...bus };
      },

      async updateBus(busId, patch) {
        const ref = doc(this.db, "users", this.uid, "buses", busId);
        await setDoc(ref, patch, { merge: true });
      },

      async deleteBus(busId) {
        const ref = doc(this.db, "users", this.uid, "buses", busId);
        await deleteDoc(ref);
      },

      async createTrip(trip) {
        const ref = await addDoc(this.tripsCol, trip);
        return { id: ref.id, ...trip };
      },

      async updateTrip(tripId, patch) {
        const ref = doc(this.db, "users", this.uid, "trips", tripId);
        await setDoc(ref, patch, { merge: true });
      },

      async updateTripFields(tripId, patch) {
        const ref = doc(this.db, "users", this.uid, "trips", tripId);
        await updateDoc(ref, patch);
      },

      async deleteTrip(tripId) {
        const ref = doc(this.db, "users", this.uid, "trips", tripId);
        await deleteDoc(ref);
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        location.replace("login.html");
        return;
      }

      // bind per-user collections
      window.__BUS.uid = user.uid;
      window.__BUS.busesCol = collection(db, "users", user.uid, "buses");
      window.__BUS.tripsCol = collection(db, "users", user.uid, "trips");

      const loading = document.getElementById("auth-loading");
      const root = document.getElementById("root");
      if (loading) loading.style.display = "none";
      if (root) root.style.display = "block";

      window.BUS_AUTH_USER = { uid: user.uid, email: user.email || "" };
      document.dispatchEvent(new CustomEvent("bus-auth-ready", { detail: window.BUS_AUTH_USER }));
    });
  </script>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;

    const Icons = {
      Bus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 6v6M15 6v6M2 12h19.6M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"/><circle cx="7" cy="18" r="2"/><path d="M9 18h5"/><circle cx="16" cy="18" r="2"/></svg>,
      Trip: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 2v4M16 2v4M3 9h18"/><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M7 13h4M7 17h6"/></svg>,
      User: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
      Plus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>,
      Print: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z"/></svg>,
      X: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18M6 6 18 18"/></svg>,
      Back: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 18l-6-6 6-6"/></svg>,
      Edit: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>,
      Trash: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>,
      Logout: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>,
      Lock: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
      Unlock: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V8a5 5 0 0 1 9-3"/></svg>,
      Check: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 6L9 17l-5-5"/></svg>,
      Search: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>,
    };

    const pad2 = (n) => String(n).padStart(2, '0');
    const toDatetimeLocal = (ms) => {
      const d = new Date(ms);
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    };
    const parseDatetimeLocal = (value) => {
      if (!value || value.indexOf('T') === -1) return Date.now();
      const [datePart, timePart] = value.split('T');
      const [y,m,d] = datePart.split('-').map(Number);
      const [hh,mm] = timePart.split(':').map(Number);
      return new Date(y, m-1, d, hh, mm, 0, 0).getTime();
    };
    const formatDateTimeAr = (ms) => {
      try { return new Intl.DateTimeFormat('ar-SA', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(ms)); }
      catch { return new Date(ms).toLocaleString(); }
    };

    const App = () => {
      const [isLoading, setIsLoading] = useState(true);
      const [data, setData] = useState({ buses: [], trips: [] });

      const [tab, setTab] = useState('trips'); // trips | buses
      const [view, setView] = useState('list'); // list | form | details
      const [activeTripId, setActiveTripId] = useState(null);

      const [busForm, setBusForm] = useState({ id: null, name: '', plate: '', seats: 49, color: '#2563eb' });
      const [tripForm, setTripForm] = useState({ id: null, busId: '', routeFrom: 'الرياض', routeTo: 'مكة', departAt: Date.now(), maxBookings: '', notes: '' });

      const [seatModal, setSeatModal] = useState({ open: false, seat: null, name: '', phone: '', paid: false, note: '', isBlocked: false });
      const [searchTerm, setSearchTerm] = useState('');
      const [highlightSeat, setHighlightSeat] = useState(null);

      // ✅ تحميل بيانات المستخدم من Firestore أول ما auth جاهز
      useEffect(() => {
        const load = async () => {
          try {
            const BUS = window.__BUS;
            if (!BUS || !BUS.uid) return;
            setIsLoading(true);
            const all = await BUS.loadAll();
            // فرز بسيط
            const buses = (all.buses || []).sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
            const trips = (all.trips || []).sort((a,b) => (b.departAt||0) - (a.departAt||0));
            setData({ buses, trips });
          } catch (e) {
            alert("صار خطأ أثناء تحميل البيانات من Firestore.");
          } finally {
            setIsLoading(false);
          }
        };

        const handler = () => load();
        document.addEventListener("bus-auth-ready", handler);

        // إذا الحدث صار قبل ما يركب React
        if (window.__BUS && window.__BUS.uid) load();

        return () => document.removeEventListener("bus-auth-ready", handler);
      }, []);

      const buses = data.buses || [];
      const trips = data.trips || [];

      const activeTrip = useMemo(() => trips.find(t => t.id === activeTripId) || null, [trips, activeTripId]);
      const activeTripBus = useMemo(() => {
        if (!activeTrip) return null;
        return buses.find(b => b.id === activeTrip.busId) || null;
      }, [activeTrip, buses]);

      const tripStats = (trip, bus) => {
        if (!trip || !bus) return { reserved: 0, paid: 0, blocked: 0, effectiveMax: 0 };
        const reserved = Object.keys(trip.reservations || {}).length;
        const paid = Object.values(trip.reservations || {}).filter(r => r && r.paid).length;
        const blocked = Object.keys(trip.blocked || {}).length;
        const availableSeats = Math.max(0, (bus.seats || 0) - blocked);
        const desiredMax = (trip.maxBookings === null || trip.maxBookings === undefined) ? availableSeats : trip.maxBookings;
        const effectiveMax = Math.min(desiredMax, availableSeats);
        return { reserved, paid, blocked, effectiveMax };
      };

      // ✅ CRUD buses (Firestore)
      const upsertBus = async (e) => {
        e.preventDefault();
        const BUS = window.__BUS;

        const seats = Math.max(1, Number(busForm.seats || 1));
        const payload = {
          name: (busForm.name || '').trim(),
          plate: (busForm.plate || '').trim().toUpperCase(),
          seats,
          color: busForm.color || '#2563eb',
          createdAt: busForm.id ? (buses.find(b => b.id === busForm.id)?.createdAt || Date.now()) : Date.now(),
        };

        try {
          if (!busForm.id) {
            const created = await BUS.createBus(payload);
            setData(prev => ({ ...prev, buses: [created, ...(prev.buses || [])] }));
          } else {
            await BUS.updateBus(busForm.id, payload);
            setData(prev => ({ ...prev, buses: (prev.buses || []).map(b => b.id === busForm.id ? { ...b, ...payload } : b) }));
          }
          setView('list');
        } catch (e2) {
          alert("تعذّر حفظ الباص. تأكد من Firestore Rules.");
        }
      };

      const deleteBus = async (busId) => {
        const bus = buses.find(b => b.id === busId);
        if (!bus) return;
        const ok = confirm(`حذف الباص "${bus.name}"؟ سيتم حذف كل الرحلات التابعة له.`);
        if (!ok) return;

        const BUS = window.__BUS;
        try {
          // احذف رحلاته أولاً
          const relatedTrips = trips.filter(t => t.busId === busId);
          for (const t of relatedTrips) {
            await BUS.deleteTrip(t.id);
          }
          await BUS.deleteBus(busId);

          setData(prev => ({
            buses: (prev.buses || []).filter(b => b.id !== busId),
            trips: (prev.trips || []).filter(t => t.busId !== busId)
          }));
        } catch (e) {
          alert("تعذّر حذف الباص/الرحلات.");
        }
      };

      // ✅ CRUD trips (Firestore)
      const upsertTrip = async (e) => {
        e.preventDefault();
        const BUS = window.__BUS;
        if (!tripForm.busId) { alert('اختر الباص'); return; }

        const bus = buses.find(b => String(b.id) === String(tripForm.busId));
        if (!bus) { alert('الباص غير موجود'); return; }

        const maxBookingsNum = (tripForm.maxBookings === '' || tripForm.maxBookings === null || tripForm.maxBookings === undefined)
          ? null
          : Math.max(0, Math.min(bus.seats, Number(tripForm.maxBookings)));

        try {
          if (!tripForm.id) {
            const payload = {
              busId: bus.id,
              routeFrom: (tripForm.routeFrom || '').trim(),
              routeTo: (tripForm.routeTo || '').trim(),
              departAt: Number(tripForm.departAt || Date.now()),
              maxBookings: maxBookingsNum,
              notes: (tripForm.notes || '').trim(),
              reservations: {},
              blocked: {},
              createdAt: Date.now(),
            };
            const created = await BUS.createTrip(payload);
            setData(prev => ({ ...prev, trips: [created, ...(prev.trips || [])] }));
          } else {
            const existing = trips.find(t => t.id === tripForm.id);
            const payload = {
              busId: bus.id,
              routeFrom: (tripForm.routeFrom || '').trim(),
              routeTo: (tripForm.routeTo || '').trim(),
              departAt: Number(tripForm.departAt || Date.now()),
              maxBookings: maxBookingsNum,
              notes: (tripForm.notes || '').trim(),
              // لا نلمس الحجوزات عند تعديل معلومات الرحلة
              reservations: existing?.reservations || {},
              blocked: existing?.blocked || {},
            };
            await BUS.updateTrip(tripForm.id, payload);
            setData(prev => ({ ...prev, trips: (prev.trips || []).map(t => t.id === tripForm.id ? { ...t, ...payload } : t) }));
          }

          setTab('trips');
          setView('list');
        } catch (e2) {
          alert("تعذّر حفظ الرحلة.");
        }
      };

      const deleteTrip = async (tripId) => {
        const ok = confirm('حذف الرحلة نهائيًا؟');
        if (!ok) return;

        const BUS = window.__BUS;
        try {
          await BUS.deleteTrip(tripId);
          setData(prev => ({ ...prev, trips: (prev.trips || []).filter(t => t.id !== tripId) }));
          setActiveTripId(null);
          setView('list');
        } catch (e) {
          alert("تعذّر حذف الرحلة.");
        }
      };

      const openTripDetails = (tripId) => {
        setActiveTripId(tripId);
        setView('details');
        setTab('trips');
        setSearchTerm('');
        setHighlightSeat(null);
      };

      // ✅ تحديث الحجوزات/المقاعد مباشرة في Firestore
      const persistTripReservations = async (tripId, patch) => {
        const BUS = window.__BUS;
        await BUS.updateTripFields(tripId, patch);
      };

      const openSeat = (num) => {
        if (!activeTrip || !activeTripBus) return;

        const stats = tripStats(activeTrip, activeTripBus);
        const reservations = activeTrip.reservations || {};
        const blocked = activeTrip.blocked || {};
        const existing = reservations[num];
        const isBlocked = !!blocked[num];

        if (!existing && !isBlocked && stats.reserved >= stats.effectiveMax) {
          alert('الرحلة مكتملة حسب الحد الأقصى المحدد.');
          return;
        }

        setSeatModal({
          open: true,
          seat: num,
          name: existing?.name || '',
          phone: existing?.phone || '',
          paid: !!existing?.paid,
          note: existing?.note || '',
          isBlocked
        });
      };

      const closeSeatModal = () => setSeatModal({ open: false, seat: null, name: '', phone: '', paid: false, note: '', isBlocked: false });

      const saveSeatReservation = async () => {
        if (!activeTrip) return;
        if (seatModal.isBlocked) { alert('هذا المقعد مغلق. افتحه أولاً ثم احجز.'); return; }
        const name = (seatModal.name || '').trim();
        if (!name) return;

        const seat = seatModal.seat;
        const payload = {
          name,
          phone: (seatModal.phone || '').trim(),
          paid: !!seatModal.paid,
          note: (seatModal.note || '').trim(),
          createdAt: Date.now()
        };

        const nextReservations = { ...(activeTrip.reservations || {}), [seat]: payload };

        try {
          await persistTripReservations(activeTrip.id, { reservations: nextReservations });
          setData(prev => ({
            ...prev,
            trips: (prev.trips || []).map(t => t.id === activeTrip.id ? { ...t, reservations: nextReservations } : t)
          }));
          closeSeatModal();
        } catch {
          alert("تعذّر حفظ الحجز.");
        }
      };

      const deleteSeatReservation = async () => {
        if (!activeTrip) return;
        const ok = confirm('إلغاء حجز هذا المقعد؟');
        if (!ok) return;

        const seat = seatModal.seat;
        const next = { ...(activeTrip.reservations || {}) };
        delete next[seat];

        try {
          await persistTripReservations(activeTrip.id, { reservations: next });
          setData(prev => ({
            ...prev,
            trips: (prev.trips || []).map(t => t.id === activeTrip.id ? { ...t, reservations: next } : t)
          }));
          closeSeatModal();
        } catch {
          alert("تعذّر إلغاء الحجز.");
        }
      };

      const toggleBlockSeat = async () => {
        if (!activeTrip) return;

        const seat = seatModal.seat;
        const nextBlocked = { ...(activeTrip.blocked || {}) };
        const nextRes = { ...(activeTrip.reservations || {}) };

        if (nextBlocked[seat]) {
          delete nextBlocked[seat];
        } else {
          if (nextRes[seat]) {
            const ok = confirm('المقعد عليه حجز. إغلاق المقعد سيحذف الحجز. هل تريد المتابعة؟');
            if (!ok) return;
            delete nextRes[seat];
          }
          nextBlocked[seat] = true;
        }

        try {
          await persistTripReservations(activeTrip.id, { blocked: nextBlocked, reservations: nextRes });
          setData(prev => ({
            ...prev,
            trips: (prev.trips || []).map(t => t.id === activeTrip.id ? { ...t, blocked: nextBlocked, reservations: nextRes } : t)
          }));
          setSeatModal(m => ({ ...m, isBlocked: !!nextBlocked[seat], name: '', phone: '', paid: false, note: '' }));
        } catch {
          alert("تعذّر تحديث حالة المقعد.");
        }
      };

      const clearAllReservations = async () => {
        if (!activeTrip) return;
        const ok = confirm('مسح جميع حجوزات هذه الرحلة؟');
        if (!ok) return;

        try {
          await persistTripReservations(activeTrip.id, { reservations: {} });
          setData(prev => ({
            ...prev,
            trips: (prev.trips || []).map(t => t.id === activeTrip.id ? { ...t, reservations: {} } : t)
          }));
        } catch {
          alert("تعذّر مسح الحجوزات.");
        }
      };

      const scrollToSeat = (seatNum) => {
        setHighlightSeat(seatNum);
        setTimeout(() => {
          const el = document.getElementById(`seat-${seatNum}`);
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 50);
        setTimeout(() => setHighlightSeat(null), 1500);
      };

      const renderLayout = (bus, trip, isPrint) => {
        if (!bus || !trip) return null;

        const seatsPerRow = 4;
        const mod = (bus.seats || 0) % seatsPerRow;
        const benchSeats = (mod === 1) ? Math.min(5, bus.seats) : (mod || seatsPerRow);
        const rows = Math.max(0, Math.floor(((bus.seats || 0) - benchSeats) / seatsPerRow));

        const elements = [];

        for (let i = 0; i < rows; i++) {
          const s = i * seatsPerRow + 1;
          elements.push(
            <div key={`row-${i}`} className="seat-grid mb-2">
              <Seat num={s} bus={bus} trip={trip} isPrint={isPrint} />
              <Seat num={s + 1} bus={bus} trip={trip} isPrint={isPrint} />
              <div className="flex items-center justify-center text-[10px] text-gray-300 font-mono italic">{i + 1}</div>
              <Seat num={s + 2} bus={bus} trip={trip} isPrint={isPrint} />
              <Seat num={s + 3} bus={bus} trip={trip} isPrint={isPrint} />
            </div>
          );
        }

        const lastSeats = [];
        for (let n = rows * seatsPerRow + 1; n <= (bus.seats || 0); n++) lastSeats.push(n);

        if (lastSeats.length) {
          elements.push(
            <div key="last" className="back-bench">
              {lastSeats.map((n) => (
                <Seat key={n} num={n} bus={bus} trip={trip} isPrint={isPrint} isLast />
              ))}
            </div>
          );
        }

        return elements;
      };

      const Seat = ({ num, trip, isPrint, isLast }) => {
        const r = (trip.reservations || {})[num];
        const isBlocked = !!(trip.blocked || {})[num];
        const isHighlighted = highlightSeat === num;

        if (isPrint) {
          return (
            <div className={`border border-black h-10 flex flex-col items-center justify-center flex-1 ${r ? 'bg-gray-100' : ''}`}>
              <span className="text-[7px] opacity-50">{num}</span>
              <span className="text-[9px] font-bold truncate px-0.5">{isBlocked ? 'مغلق' : (r ? r.name : 'فارغ')}</span>
            </div>
          );
        }

        const base = `h-14 rounded-xl border-2 flex flex-col items-center justify-center relative active:scale-90 transition-transform ${isLast ? 'flex-1' : ''}`;
        let cls = 'bg-white border-slate-100 shadow-sm text-slate-700';
        let badge = null;

        if (isBlocked) {
          cls = 'bg-slate-200 border-slate-300 text-slate-600';
          badge = <span className="text-[9px] font-bold">مغلق</span>;
        } else if (r && r.paid) {
          cls = 'bg-emerald-600 border-emerald-600 text-white';
          badge = <span className="text-[9px] font-bold">مدفوع</span>;
        } else if (r) {
          cls = 'bg-slate-800 border-slate-800 text-white';
          badge = <span className="text-[9px] font-bold">محجوز</span>;
        } else {
          badge = <span className="text-[9px] text-gray-400 font-bold">متاح</span>;
        }

        const ring = isHighlighted ? 'ring-4 ring-yellow-300' : '';

        return (
          <button
            id={`seat-${num}`}
            onClick={() => openSeat(num)}
            className={`${base} ${cls} ${ring}`}
          >
            <span className="absolute top-1 left-1.5 text-[8px] opacity-40">{num}</span>
            {isBlocked ? <Icons.Lock /> : (r ? <Icons.User /> : null)}
            {badge}
            {r && !isBlocked && <span className="text-[9px] w-full truncate px-1 font-bold mt-1">{r.name}</span>}
          </button>
        );
      };

      const logout = async () => {
        try {
          await window.__BUS.signOut();
          location.replace("login.html");
        } catch {
          alert("صار خطأ أثناء تسجيل الخروج.");
        }
      };

      const TripsList = () => {
        const sorted = [...trips].sort((a,b) => (b.departAt||0) - (a.departAt||0));
        return (
          <div className="space-y-4">
            {sorted.length === 0 && <div className="text-center py-16 text-slate-300">لا يوجد رحلات. اضغط + لإضافة رحلة.</div>}
            {sorted.map((t) => {
              const bus = buses.find(b => b.id === t.busId);
              const stats = tripStats(t, bus);
              const route = `${t.routeFrom || '---'} → ${t.routeTo || '---'}`;
              return (
                <div key={t.id} onClick={() => openTripDetails(t.id)}
                     className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between active:scale-95 transition-transform cursor-pointer">
                  <div className="flex items-center gap-4 min-w-0">
                    <div className="w-1.5 h-12 rounded-full" style={{ backgroundColor: bus ? bus.color : '#cbd5e1' }}></div>
                    <div className="min-w-0">
                      <h3 className="font-bold text-lg text-slate-800 truncate">{route}</h3>
                      <p className="text-sm text-slate-500">{formatDateTimeAr(t.departAt || Date.now())}</p>
                      <p className="text-xs text-slate-400 font-mono uppercase truncate">{bus ? `${bus.name} • ${bus.plate}` : 'باص محذوف'}</p>
                    </div>
                  </div>
                  <div className={`text-xs font-bold px-3 py-1.5 rounded-xl ${stats.reserved >= stats.effectiveMax ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-700'}`}>
                    {stats.reserved}/{stats.effectiveMax}
                  </div>
                </div>
              );
            })}
          </div>
        );
      };

      const BusesList = () => (
        <div className="space-y-4">
          {buses.length === 0 && <div className="text-center py-16 text-slate-300">لا يوجد باصات. اضغط + لإضافة باص.</div>}
          {buses.map((b) => (
            <div key={b.id} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
              <div className="flex items-center gap-4 min-w-0">
                <div className="w-1.5 h-12 rounded-full" style={{ backgroundColor: b.color || '#2563eb' }}></div>
                <div className="min-w-0">
                  <h3 className="font-bold text-lg text-slate-800 truncate">{b.name}</h3>
                  <p className="text-sm text-slate-400 font-mono tracking-widest uppercase truncate">{b.plate}</p>
                  <p className="text-xs text-slate-400">مقاعد: <span className="font-bold">{b.seats}</span></p>
                </div>
              </div>
              <div className="flex gap-2">
                <button onClick={() => { setBusForm({ id: b.id, name: b.name, plate: b.plate, seats: b.seats, color: b.color }); setView('form'); setTab('buses'); }}
                        className="p-2.5 rounded-xl bg-slate-100 text-slate-700 active:bg-slate-200" title="تعديل">
                  <Icons.Edit />
                </button>
                <button onClick={() => deleteBus(b.id)} className="p-2.5 rounded-xl bg-red-50 text-red-600 active:bg-red-100" title="حذف">
                  <Icons.Trash />
                </button>
              </div>
            </div>
          ))}
        </div>
      );

      const TripDetails = () => {
        if (!activeTrip || !activeTripBus) return <div className="bg-white p-6 rounded-2xl border border-gray-100 text-slate-500">الرحلة غير موجودة أو الباص محذوف.</div>;
        const stats = tripStats(activeTrip, activeTripBus);
        const route = `${activeTrip.routeFrom || '---'} → ${activeTrip.routeTo || '---'}`;

        const resEntries = Object.entries(activeTrip.reservations || {})
          .map(([seat, r]) => ({ seat: Number(seat), ...r }))
          .sort((a,b) => a.seat - b.seat);

        const q = (searchTerm || '').trim().toLowerCase();
        const filtered = resEntries.filter(r =>
          !q ||
          String(r.seat).includes(q) ||
          String(r.name || '').toLowerCase().includes(q) ||
          String(r.phone || '').toLowerCase().includes(q) ||
          String(r.note || '').toLowerCase().includes(q)
        );

        return (
          <div className="space-y-4">
            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 border-r-8" style={{ borderColor: activeTripBus.color || '#2563eb' }}>
              <div className="flex items-start justify-between gap-4">
                <div className="min-w-0">
                  <h2 className="text-2xl font-bold text-slate-800 truncate">{route}</h2>
                  <p className="text-slate-500">{formatDateTimeAr(activeTrip.departAt || Date.now())}</p>
                  <p className="text-xs text-slate-400 font-mono uppercase truncate">{activeTripBus.name} • {activeTripBus.plate}</p>
                </div>
                <div className="text-left">
                  <div className="text-blue-600 font-bold text-xl">{stats.reserved} / {stats.effectiveMax}</div>
                  <div className="text-xs text-slate-500 mt-1">مدفوع: <span className="font-bold">{stats.paid}</span></div>
                </div>
              </div>

              <div className="mt-4 flex flex-wrap gap-2">
                <button onClick={() => window.print()} className="px-4 py-2 rounded-2xl bg-orange-100 text-orange-700 font-bold active:bg-orange-200 flex items-center gap-2">
                  <Icons.Print /> طباعة
                </button>

                <button onClick={() => { clearAllReservations(); }} className="px-4 py-2 rounded-2xl bg-red-50 text-red-700 font-bold active:bg-red-100">
                  مسح الحجوزات
                </button>

                <button onClick={() => deleteTrip(activeTrip.id)} className="px-4 py-2 rounded-2xl bg-red-600 text-white font-bold active:bg-red-700 flex items-center gap-2">
                  <Icons.Trash /> حذف الرحلة
                </button>
              </div>
            </div>

            <div className="bg-white p-5 rounded-3xl border border-gray-100">
              <h3 className="font-bold text-slate-800 mb-4">مخطط المقاعد</h3>
              {renderLayout(activeTripBus, activeTrip, false)}
            </div>

            <div className="bg-white p-5 rounded-3xl border border-gray-100">
              <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
                <h3 className="font-bold text-slate-800">قائمة الركاب</h3>
                <div className="relative w-full sm:w-80">
                  <div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
                  <input className="w-full p-3 pr-11 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                         placeholder="ابحث بالاسم/الجوال/رقم المقعد/ملاحظة..."
                         value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                </div>
              </div>

              {filtered.length === 0 ? (
                <div className="text-center text-slate-400 py-10">لا توجد نتائج</div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className="text-slate-500">
                      <tr className="border-b">
                        <th className="py-2 text-right">مقعد</th>
                        <th className="py-2 text-right">الاسم</th>
                        <th className="py-2 text-right">الجوال</th>
                        <th className="py-2 text-right">الدفع</th>
                        <th className="py-2 text-right">ملاحظة</th>
                        <th className="py-2 text-right">إجراء</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filtered.map((r) => (
                        <tr key={r.seat} className="border-b last:border-b-0">
                          <td className="py-2 font-bold">{r.seat}</td>
                          <td className="py-2 font-bold text-slate-800">{r.name}</td>
                          <td className="py-2 font-mono text-slate-600">{r.phone || '-'}</td>
                          <td className="py-2">
                            <span className={`px-2 py-1 rounded-xl text-xs font-bold ${r.paid ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-700'}`}>
                              {r.paid ? 'مدفوع' : 'غير مدفوع'}
                            </span>
                          </td>
                          <td className="py-2 text-slate-600 truncate max-w-[180px]">{r.note || '-'}</td>
                          <td className="py-2">
                            <button onClick={() => scrollToSeat(r.seat)} className="px-3 py-1.5 rounded-xl bg-slate-100 text-slate-700 font-bold active:bg-slate-200">
                              عرض المقعد
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        );
      };

      if (isLoading) {
        return (
          <div className="min-h-screen bg-slate-50 flex items-center justify-center text-slate-500">
            جار تحميل بياناتك من Firestore...
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-50 flex flex-col">
          <header className="bg-white p-4 shadow-sm flex items-center justify-between no-print">
            <div className="flex items-center gap-3">
              {view === 'details' ? (
                <button onClick={() => { setView('list'); setActiveTripId(null); setSearchTerm(''); }}
                        className="p-2.5 rounded-xl bg-slate-100 text-slate-700 active:bg-slate-200" title="رجوع">
                  <Icons.Back />
                </button>
              ) : null}

              <div className="bg-blue-600 text-white p-2 rounded-xl shadow-lg shadow-blue-200">
                {tab === 'trips' ? <Icons.Trip /> : <Icons.Bus />}
              </div>

              <div>
                <h1 className="text-lg font-bold text-slate-800">{tab === 'trips' ? 'إدارة الرحلات' : 'إدارة الباصات'}</h1>
                <p className="text-xs text-slate-400">كل بياناتك محفوظة بحسابك (Firestore)</p>
              </div>
            </div>

            <div className="flex items-center gap-2">
              {view !== 'details' && (
                <div className="flex gap-2">
                  <button onClick={() => { setTab('trips'); setView('list'); }}
                          className={`px-4 py-2 rounded-2xl font-bold flex items-center gap-2 ${tab === 'trips' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'}`}>
                    <Icons.Trip /> الرحلات
                  </button>
                  <button onClick={() => { setTab('buses'); setView('list'); }}
                          className={`px-4 py-2 rounded-2xl font-bold flex items-center gap-2 ${tab === 'buses' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'}`}>
                    <Icons.Bus /> الباصات
                  </button>
                </div>
              )}

              <button onClick={logout} className="px-3 py-2 rounded-2xl bg-slate-900 text-white font-bold flex items-center gap-2 active:bg-slate-800">
                <Icons.Logout />
                <span className="hidden sm:inline">خروج</span>
              </button>
            </div>
          </header>

          <main className="flex-1 p-4 max-w-2xl mx-auto w-full no-print">
            {view === 'list' && tab === 'trips' && <TripsList />}
            {view === 'list' && tab === 'buses' && <BusesList />}

            {view === 'form' && tab === 'buses' && (
              <form onSubmit={upsertBus} className="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 space-y-4">
                <h2 className="text-2xl font-bold mb-2 text-slate-800">{busForm.id ? 'تعديل الباص' : 'إضافة باص جديد'}</h2>

                <input className="w-full p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 text-lg outline-none"
                       value={busForm.name} onChange={e => setBusForm({ ...busForm, name: e.target.value })} required placeholder="اسم الباص" />

                <input className="w-full p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 text-lg font-mono uppercase outline-none"
                       value={busForm.plate} onChange={e => setBusForm({ ...busForm, plate: e.target.value })} required placeholder="رقم اللوحة" />

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs text-slate-500 font-bold">عدد المقاعد</label>
                    <input type="number" min="1" className="w-full mt-1 p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 outline-none"
                           value={busForm.seats} onChange={e => setBusForm({ ...busForm, seats: Number(e.target.value) })} required />
                  </div>
                  <div>
                    <label className="text-xs text-slate-500 font-bold">لون الباص</label>
                    <input type="color" className="w-full mt-1 h-[56px] p-2 rounded-2xl bg-slate-50 ring-1 ring-slate-200 outline-none"
                           value={busForm.color} onChange={e => setBusForm({ ...busForm, color: e.target.value })} />
                  </div>
                </div>

                <div className="flex gap-3 pt-2">
                  <button type="button" onClick={() => setView('list')}
                          className="flex-1 p-4 rounded-2xl font-bold text-slate-500 bg-slate-100 active:bg-slate-200">إلغاء</button>
                  <button type="submit" className="flex-1 p-4 rounded-2xl font-bold text-white bg-blue-600 shadow-lg shadow-blue-200 active:bg-blue-700">حفظ</button>
                </div>
              </form>
            )}

            {view === 'form' && tab === 'trips' && (
              <form onSubmit={upsertTrip} className="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 space-y-4">
                <h2 className="text-2xl font-bold mb-2 text-slate-800">{tripForm.id ? 'تعديل الرحلة' : 'إضافة رحلة جديدة'}</h2>

                <div>
                  <label className="text-xs text-slate-500 font-bold">اختر الباص</label>
                  <select className="w-full mt-1 p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                          value={tripForm.busId} onChange={e => setTripForm({ ...tripForm, busId: e.target.value })} required>
                    <option value="">-- اختر --</option>
                    {buses.map(b => <option key={b.id} value={b.id}>{b.name} • {b.plate} • {b.seats} مقعد</option>)}
                  </select>
                  {buses.length === 0 ? <p className="text-xs text-red-600 mt-2">لا يوجد باصات. أضف باص أولاً.</p> : null}
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs text-slate-500 font-bold">من</label>
                    <input className="w-full mt-1 p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                           value={tripForm.routeFrom} onChange={e => setTripForm({ ...tripForm, routeFrom: e.target.value })} placeholder="مثلاً: الرياض" />
                  </div>
                  <div>
                    <label className="text-xs text-slate-500 font-bold">إلى</label>
                    <input className="w-full mt-1 p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                           value={tripForm.routeTo} onChange={e => setTripForm({ ...tripForm, routeTo: e.target.value })} placeholder="مثلاً: مكة / الأردن" />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs text-slate-500 font-bold">وقت الانطلاق</label>
                    <input type="datetime-local" className="w-full mt-1 p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                           value={toDatetimeLocal(tripForm.departAt)} onChange={(e) => setTripForm({ ...tripForm, departAt: parseDatetimeLocal(e.target.value) })} required />
                  </div>
                  <div>
                    <label className="text-xs text-slate-500 font-bold">الحد الأقصى للحجوزات (اختياري)</label>
                    <input type="number" min="0" className="w-full mt-1 p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                           value={tripForm.maxBookings} onChange={(e) => setTripForm({ ...tripForm, maxBookings: e.target.value })} placeholder="اتركه فارغ = حسب المقاعد المتاحة" />
                  </div>
                </div>

                <div>
                  <label className="text-xs text-slate-500 font-bold">ملاحظات</label>
                  <textarea className="w-full mt-1 p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
                            rows="3" value={tripForm.notes} onChange={(e) => setTripForm({ ...tripForm, notes: e.target.value })} placeholder="تعليمات خاصة..." />
                </div>

                <div className="flex gap-3 pt-2">
                  <button type="button" onClick={() => setView('list')}
                          className="flex-1 p-4 rounded-2xl font-bold text-slate-500 bg-slate-100 active:bg-slate-200">إلغاء</button>
                  <button type="submit" className="flex-1 p-4 rounded-2xl font-bold text-white bg-blue-600 shadow-lg shadow-blue-200 active:bg-blue-700" disabled={buses.length === 0}>
                    حفظ الرحلة
                  </button>
                </div>
              </form>
            )}

            {view === 'details' && tab === 'trips' && <TripDetails />}
          </main>

          {view === 'list' && (
            <button
              onClick={() => {
                if (tab === 'buses') {
                  setBusForm({ id: null, name: '', plate: '', seats: 49, color: '#2563eb' });
                  setView('form');
                } else {
                  setTripForm({
                    id: null,
                    busId: buses[0] ? buses[0].id : '',
                    routeFrom: 'الرياض',
                    routeTo: 'مكة',
                    departAt: Date.now() + 60*60*1000,
                    maxBookings: '',
                    notes: ''
                  });
                  setView('form');
                }
              }}
              className="fixed bottom-10 left-10 w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-75 transition-transform no-print"
              title="إضافة"
            >
              <Icons.Plus />
            </button>
          )}

          {seatModal.open && (
            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-6 no-print"
                 onClick={(e) => { if (e.target === e.currentTarget) closeSeatModal(); }}>
              <div className="bg-white w-full max-w-md rounded-[32px] p-7 shadow-2xl">
                <div className="flex justify-between items-center mb-5">
                  <h3 className="text-2xl font-bold text-slate-800">المقعد {seatModal.seat}</h3>
                  <button onClick={closeSeatModal} className="p-2 rounded-xl bg-slate-100 active:bg-slate-200"><Icons.X /></button>
                </div>

                <div className="flex items-center justify-between gap-2 mb-4">
                  <button onClick={toggleBlockSeat}
                          className={`flex-1 p-3 rounded-2xl font-bold flex items-center justify-center gap-2 ${seatModal.isBlocked ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-700'}`}>
                    {seatModal.isBlocked ? <Icons.Unlock /> : <Icons.Lock />}
                    {seatModal.isBlocked ? 'فتح المقعد' : 'إغلاق المقعد'}
                  </button>

                  <button onClick={() => setSeatModal((m) => ({ ...m, paid: !m.paid }))}
                          className={`flex-1 p-3 rounded-2xl font-bold flex items-center justify-center gap-2 ${seatModal.paid ? 'bg-emerald-600 text-white' : 'bg-orange-100 text-orange-700'}`}
                          disabled={seatModal.isBlocked}>
                    <Icons.Check /> {seatModal.paid ? 'مدفوع' : 'غير مدفوع'}
                  </button>
                </div>

                <div className={`${seatModal.isBlocked ? 'opacity-50 pointer-events-none' : ''}`}>
                  <input autoFocus className="w-full p-4 rounded-2xl bg-slate-50 ring-2 ring-slate-100 focus:ring-blue-500 text-lg mb-3 outline-none"
                         placeholder="اسم الراكب..." value={seatModal.name} onChange={e => setSeatModal({ ...seatModal, name: e.target.value })} />

                  <input className="w-full p-4 rounded-2xl bg-slate-50 ring-2 ring-slate-100 focus:ring-blue-500 text-lg mb-3 outline-none"
                         placeholder="رقم الجوال (اختياري)" value={seatModal.phone} onChange={e => setSeatModal({ ...seatModal, phone: e.target.value })} inputMode="tel" />

                  <textarea className="w-full p-4 rounded-2xl bg-slate-50 ring-2 ring-slate-100 focus:ring-blue-500 text-base mb-4 outline-none"
                            placeholder="ملاحظة (اختياري)" value={seatModal.note} onChange={e => setSeatModal({ ...seatModal, note: e.target.value })} rows="2" />
                </div>

                <div className="flex flex-col gap-2">
                  <button onClick={saveSeatReservation}
                          className="p-4 rounded-2xl bg-blue-600 text-white font-bold text-lg shadow-lg active:bg-blue-700"
                          disabled={seatModal.isBlocked}>
                    {seatModal.isBlocked ? 'المقعد مغلق' : 'حفظ الحجز'}
                  </button>

                  {activeTrip && activeTrip.reservations && activeTrip.reservations[seatModal.seat] && (
                    <button onClick={deleteSeatReservation}
                            className="p-4 rounded-2xl bg-red-50 text-red-600 font-bold active:bg-red-100">
                      إلغاء الحجز
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}

          <div className="print-only p-6 bg-white text-black" dir="rtl">
            {activeTrip && activeTripBus && (
              <div className="print-container">
                <div className="flex justify-between items-end border-b-2 border-black pb-3 mb-3">
                  <div>
                    <h1 className="text-xl font-bold">كشف ركاب رسمي</h1>
                    <p>التاريخ: {new Date().toLocaleDateString('ar-SA')}</p>
                    <p>موعد الانطلاق: {formatDateTimeAr(activeTrip.departAt || Date.now())}</p>
                  </div>
                  <div className="text-left">
                    <h2 className="text-lg font-bold">{activeTrip.routeFrom || '---'} → {activeTrip.routeTo || '---'}</h2>
                    <div className="mt-1 border border-black px-4 py-1 font-bold uppercase font-mono">{activeTripBus.plate}</div>
                    <div className="text-sm mt-1">{activeTripBus.name}</div>
                  </div>
                </div>

                <div className="mb-4">{renderLayout(activeTripBus, activeTrip, true)}</div>

                <div className="mt-8 pt-6 border-t border-black text-center text-sm">
                  التوقيع والختم: ............................
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
